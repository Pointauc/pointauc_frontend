import { FC, ReactNode, useState } from 'react';
import { Button, Checkbox, Dialog, DialogContent, DialogTitle, FormControlLabel, FormGroup } from '@mui/material';
import { DropzoneArea } from 'react-mui-dropzone';
import { useTranslation } from 'react-i18next';

import { parseSlotsPreset } from '@utils/slots.utils.ts';
import { Slot } from '@models/slot.model.ts';

import './SlotsPresetInput.scss';

interface SlotsPresetInput {
  buttonTitle: string;
  onChange: (items: Slot[], saveSlots: boolean) => void;
  buttonClass?: string;
  dialogTitle?: ReactNode;
  hint?: ReactNode;
}

const SlotsPresetInput: FC<SlotsPresetInput> = ({ onChange, buttonTitle, buttonClass, dialogTitle, hint }) => {
  const { t } = useTranslation();
  const [isInputOpened, setIsInputOpened] = useState<boolean>(false);
  const [saveSlots, setSaveSlots] = useState<boolean>(false);
  const [noCosts, setNoCosts] = useState<boolean>(false);
  const toggleDialog = (): void => {
    setIsInputOpened((prevOpened) => !prevOpened);
  };

  const handleFileUpload = ([file]: File[]): void => {
    const reader = new FileReader();

    reader.onloadend = (): void => {
      if (typeof reader.result === 'string') {
        onChange(parseSlotsPreset(reader.result, noCosts), saveSlots);
        setIsInputOpened(false);
      }
    };
    reader.readAsText(file);
  };

  const handleSaveSlotsChange = (event: any): void => {
    setSaveSlots(event.target.checked);
  };

  const handleNoCostsChange = (event: any): void => {
    setNoCosts(event.target.checked);
  };

  return (
    <div className='slots-preset-input'>
      <Dialog open={isInputOpened} onClose={toggleDialog} maxWidth={false}>
        {!!dialogTitle && <DialogTitle>{dialogTitle}</DialogTitle>}
        <DialogContent className='image-input-wrapper'>
          <DropzoneArea
            dropzoneClass='drop-zone'
            dropzoneText={t('common.moveFileOrClick')}
            onDrop={handleFileUpload}
            filesLimit={1}
          />
          <FormGroup row={true}>
            <FormControlLabel
              className='save-slots-checkbox'
              control={<Checkbox checked={saveSlots} onChange={handleSaveSlotsChange} color='primary' />}
              label={t('wheel.addLotsToAuc')}
            />
            <FormControlLabel
              className='save-slots-checkbox'
              control={<Checkbox checked={noCosts} onChange={handleNoCostsChange} color='primary' />}
              label={t('wheel.lotsWithoutCosts')}
            />
          </FormGroup>
          {hint && <div className='slots-preset-input-hint'>{hint}</div>}
        </DialogContent>
      </Dialog>
      <Button variant='outlined' color='primary' onClick={toggleDialog} className={buttonClass}>
        {buttonTitle}
      </Button>
    </div>
  );
};

export default SlotsPresetInput;
